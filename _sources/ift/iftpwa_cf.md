# iftpwa - Correlated Field Model

## Correlated Field Model in NIFTy
Please read the following first, perhaps run the code yourself to see how the correlated field model works in NIFTy. This model forms the basis of the iftpwa package.
[Showcasing the Correlated Field Model (NIFTy)](https://ift.pages.mpcdf.de/nifty/user/old_nifty_getting_started_4_CorrelatedFields.html)

```{note}
The correlated field model is no longer a Gaussian process but it does make understanding and explaining the IFT approach easier
```

## Simplified Model

```{warning}
`t` and `tPrime` are used interchangeably everywhere in the framework but generally variables in source code will have `tPrime` as part of their name. `PyAmpTools` currently forms the kinematic binning using `t`.
```

The following simplified amplitude description is used to depict how the configuration file key-value fields affect the model for each amplitude. The first term in the brackets describes a non-parameteric component which can be adept at describing unknown background contributions. The second term describes a parameteric component which we generally have a physical description for (i.e. Breit-Wigner, Flatt√©, ...)

$$
\begin{aligned}
A_i(m, t) = \kappa \cdot \rho_i \cdot C_i \cdot \Big[ 
    & S_b \cdot G(m \mid s_{m,i},\; f_{m,i},\; a_{m,i}) \cdot G(t \mid s_{t,i},\; f_{t,i},\; a_{t,i}) \cdot I_i \\
    & + S_r \sum_p \cdot\; S_{p,i} \cdot P_{p,i}(m \mid \vec{x_{p,i}}) \cdot T_{p,i}(t)
\Big]
\end{aligned}
$$

- $m$ is the mass
- $t$ is the transfer momentum
- $i$ is the wave index
- $\kappa$ is a constant kinematic factor. Expression hardcoded in `iftpwa/src/model/model_builder.py`, under development for GlueX. Currently just squared barrier factor.
- $S_b$ is the constant `bkg2res` factor scaling ALL background contributions (all waves) by the same amount
- $S_r$ is the constant `res2bkg` factor scaling ALL parametric contributions (all waves) by the same amount
- $\rho_i$ is the dictionary of constant phase space factors for the $i^{th}$ partial wave stored in a single pkl file, `phaseSpaceMultiplier`. Can be generated by `pa calc_ps` command
- $C_i$ is the overall scale factor for the $i^{th}$ partial wave. This is a random variable with half-normal / laplace priors. Without this, every amplitude should be O(1) scale, defined by `IFT_MODEL.scale`
- $G(s_i, f_i, a_i)$ is the Correlated field model with scale, flexibility, asperity, for the $i^{th}$ partial wave defined by `IFT_MODEL`. These parameters are random variables and are log-normal distributed. Mass and transfer momentum is factorized as a product of two correlated fields
- $I_i$ is the indicator function to zero the Correlated field component for a particular partial wave, indicated by `no_bkg` key in each resonance model. Useful if only want parameteric component in a specific wave
- $\sum_p$ sums over parametric components (multiple components can contribute to a single partial wave) defined by `PARAMETRIC_MODEL`
- $S_p$ is the constant `preScale` factor for the particular parametric component, $p$. Correlated field model at this point is roughly O(1) so this allows us to bias towards larger/smaller intensity from parameteric component
- $P(m \mid \vec{x_{p,i}})$ is the `PARAMETRIC_MODEL` component describing the mass dependence of the parameteric component with parameters $\vec{x_{p,i}}$ defined by `parameter_priors` (and also `static_paras`)
- $T(t)$ models the t-dependence for the Parameteric term. It can be another correlated field (with hardcoded power spectrum parameters) if `PARAMETRIC_MODEL.smoothScales` is true

```{note}
This amplitude description is for a single real/imaginary component of a particular partial wave. The correlated field parameters (defined as priors), $s_i, f_i, a_i$, are shared across all partial waves. This does not mean all the particular $s_i, f_i, a_i$ across partial waves are the same, as they are random variables. Though the real/imaginary components of a partial wave do share the same parameter values. 
```